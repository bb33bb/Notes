<!-- TOC -->

- [1. 逃逸ssh登录日志于last、w命令](#1-逃逸ssh登录日志于lastw命令)
    - [1.1. w和last命令原理](#11-w和last命令原理)
    - [1.2. 逃逸](#12-逃逸)
        - [1.2.1. 逃逸命令1](#121-逃逸命令1)
        - [1.2.2. 逃逸命令2](#122-逃逸命令2)
        - [1.2.3. 逃逸命令3](#123-逃逸命令3)
    - [1.3. 反逃逸](#13-反逃逸)
        - [1.4. 如果登录正在进行](#14-如果登录正在进行)
        - [1.5. 发现历史登录](#15-发现历史登录)

<!-- /TOC -->
# 1. 逃逸ssh登录日志于last、w命令
## 1.1. w和last命令原理
`w`命令显示信息来源于utmp，`last`命令显示信息来源于wtmp，并不是所有程序登录的时候都会调用utmp和wtmp日志记录接口，只有交互式会话，才会调用utmp和wtmp的日志记录接口，比如通过tty或者pts或者图形界面登录的都会调用utmp和wtmp日志记录接口，然后我们在使用`w`和`last`命令的时候就会发现登录信息
## 1.2. 逃逸
### 1.2.1. 逃逸命令1
`ssh -lroot 192.168.226.130 /usr/bin/bash`（此命令需要在Linux下执行，xshell不支持）。这个命令其实就相当于登录之后直接调用bash这个程序，此时系统没有为其分配tty，不算一个完整交互式会话，只不过bash 接受输入，然后有输出，让我们误以为是交互式会话，其实不然，你可以将/usr/bin/bash 替换成/usr/bin/ls 试一下，就是简单执行以下就退出了
### 1.2.2. 逃逸命令2
`ssh -T root@192.168.226.130 /usr/bin/bash -i`还有一种看起来更像是交互式会话的，-T 表示不分配伪终端 （正常的会话，在分配伪终端之后才会调用utmp和wtmp的日志接口），-i 表示是交互式shell
### 1.2.3. 逃逸命令3
scp、sftp等登录方式也不涉及交互式会话
## 1.3. 反逃逸
### 1.4. 如果登录正在进行
* 通过lsof、netstat找到ssh端口通信
* 通过ps找到ssh进程
### 1.5. 发现历史登录
分析`/var/log/secure`（有的系统是`/var/log/auth.log`）文件，从`Accepted publickey for root from 192.168.226.131`可以得知登录时间，从`Disconnected from 192.168.226.131 port 43000`可以得知退出时间
